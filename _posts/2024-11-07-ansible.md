---
layout: post
author: Bruce Lee
title: Ansible and Terraform SCP
---

# ğŸ‘¨â€ğŸ“ Ansible and Terraform SCP<br/><br/>

## Ansible
- ë§ì€ ì„œë²„ë“¤ì— ë™ì‹œì—, ë™ì¼í•œ í™˜ê²½ì„ ë°°í¬í•´ì•¼ í•˜ëŠ” ìƒí™©ì—ì„œ Bash ì‰˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¶„ëª… í•œê³„ì ì„ ê°€ì§„ë‹¤. ì•¤ì„œë¸”ì€ ì´ëŸ¬í•œ ì—¬ëŸ¬ ê°œì˜ ì„œë²„ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ê³ ì•ˆëœ í™˜ê²½ êµ¬ì„± ìë™í™” ë„êµ¬ì´ë‹¤.
- ë§ì€ ì„œë²„ë¥¼ ê°™ì€ í…œí”Œë¦¿ì˜ ì¸í”„ë¼ë¡œ ì‘ì„±í•˜ê¸° ìœ„í•´ ìƒê²¨ë‚œ ê°œë…ì´ IaC (Infrastructure as a Code) ì˜ ê°œë…ì´ë‹¤.

### Ansible vs Terraform ?
> í…Œë¼í¼ì€ HashiCorpì—ì„œ ê°œë°œí•œ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ as ì½”ë“œ(IaC) ë„êµ¬ë¡œ, í´ë¼ìš°ë“œ ê¸°ë°˜ ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ”ë° ì£¼ë¡œ ì‚¬ìš©ëœë‹¤.
> ë°˜ë©´, ì•¤ì„œë¸”ì€ Red Hatì—ì„œ ê°œë°œí•œ IT ìë™í™” ë„êµ¬ë¡œ, ì„œë²„ êµ¬ì„± ê´€ë¦¬ì™€ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ë“±ì— ì£¼ë¡œ ì‚¬ìš©ëœë‹¤.

- Terraform : HCL ì–¸ì–´ë¡œ êµ¬ì„±, í´ë¼ìš°ë“œ ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤ ìƒì„± ë° ê´€ë¦¬, ë©€í‹° í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œì˜ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ì— ì‚¬ìš©
- Ansible : YAML ì–¸ì–´ë¡œ êµ¬ì„±, ì„œë²„ êµ¬ì„± ê´€ë¦¬, ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬, ì‘ì—… ì‹¤í–‰ì— ì‚¬ìš©
- ë‘˜ë‹¤ ìƒíƒœ ì •ë³´ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ë³„ë„ì˜ ì¸í”„ë¼ê°€ í•„ìš”í•˜ì§€ ì•ŠëŠ”ë‹¤.
- Ansible ì˜ ê²½ìš° ì£¼ë¡œ êµ¬ì„± ê´€ë¦¬ì— ë§ì¶°ì ¸ ìˆë‹¤. êµ¬ì„± ê´€ë¦¬ë€ ë²„ì „ì´ ì§€ì •ëœ ì†Œí”„íŠ¸ì›¨ì–´ êµ¬ì„± ìš”ì†Œ ì„¤ì¹˜, OS êµ¬ì„± ì‘ì—…, ë„¤íŠ¸ì›Œí¬ ë° ë°©í™”ë²½ êµ¬ì„±ì„ ìë™í™”í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ë“±ì„ ë§í•œë‹¤.
- Ansible ì€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ Playbook ì´ë¼ê³  í•˜ë©° ì ˆì°¨ì  ì–¸ì–´ë¡œ íŠ¹ì • ì¼ë ¨ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” ê²½ìš° í”Œë ˆì´ë¶ì—ì„œ ë™ì¼í•œ ì‘ì—…ì„ ì •ì˜í•˜ê³ , ì‘ì—…ì€ ì‘ì„±ëœ ìˆœì„œëŒ€ë¡œ ìˆ˜í–‰ëœë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´, ë£¨íŠ¸ ì‚¬ìš©ìë§Œ ì§€ì •ëœ ë¨¸ì‹ ì— ì„œë²„ë¥¼ ì„¤ì¹˜í•˜ë ¤ëŠ” ê²½ìš° ì„¤ì¹˜ ì‘ì—… ì „ì— ì‚¬ìš©ì ìƒì„± ë‹¨ê³„ë¥¼ ì‘ì„±í•´ì•¼ í•œë‹¤.
- ì¸ë²¤í† ë¦¬ëŠ” ì•¤ì„œë¸”ì„ ì´ìš©í•˜ì—¬ ì‘ì—…ì„ ì§„í–‰í•  ì„œë²„ì˜ ì •ë³´ì™€ ì‘ì—…ì— ì‚¬ìš©í•  ë³€ìˆ˜ ì •ë³´ë¥¼ ì €ì¥í•œë‹¤.
- ì œì–´ ë…¸ë“œëŠ” ì•¤ì„œë¸”ì„ ì‹¤í–‰í•˜ëŠ” ë…¸ë“œì´ë‹¤. /usr/bin/ansible ì´ë‚˜ /usr/bin/ansible-playbook ëª…ë ¹ì„ ì´ìš©í•˜ì—¬ ì œì–´ ë…¸ë“œì—ì„œ ê´€ë¦¬ ë…¸ë“œë“¤ì„ ê´€ë¦¬í•œë‹¤. ì•¤ì„œë¸”ì´ ì„¤ì¹˜ ë˜ì–´ ìˆìœ¼ë©´ ë…¸íŠ¸ë¶ì´ë‚˜, ì„œë²„ê¸‰ ì»´í“¨í„°ë¥¼ ì œì–´ ë…¸ë“œë¡œ ì´ìš©í•  ìˆ˜ ìˆë‹¤.
- ì•¤ì„œë¸”ë¡œ ê´€ë¦¬í•˜ëŠ” ì„œë²„ë¥¼ ë§¤ë‹ˆì§€ë“œ ë…¸ë“œë¼ê³  í•œë‹¤. ë§¤ë‹ˆì§€ë“œ ë…¸ë“œëŠ” í˜¸ìŠ¤íŠ¸ë¼ê³ ë„ í•œë‹¤. ë§¤ë‹ˆì§€ë“œ ë…¸ë“œì—ëŠ” ì•¤ì„œë¸”ì´ ì„¤ì¹˜ ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ë§¤ë‹ˆì§€ë“œ ë…¸ë“œ ëª©ë¡ì„ ì¸ë²¤í† ë¦¬ë¼ê³  í•œë‹¤. ì¸ë²¤í† ë¦¬ íŒŒì¼ì€ í˜¸ìŠ¤íŠ¸ íŒŒì¼ì´ë¼ê³ ë„ í•œë‹¤. ì¸ë²¤í† ë¦¬ëŠ” ê° ë§¤ë‹ˆì§€ë“œ ë…¸ë“œì— ëŒ€í•œ IP ì£¼ì†Œ, í˜¸ìŠ¤íŠ¸ ì •ë³´, ë³€ìˆ˜ì™€ ê°™ì€ ì •ë³´ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤.
- Terraform ì˜ ê²½ìš° ë³€ê²½ ì‚¬í•­ì´ ë„ì…ë˜ë©´ ë³€ê²½ ì‚¬í•­ ìì²´ì˜ íŠ¹ì„±ì— ë”°ë¼ ì‹¤í–‰ë˜ëŠ” ë°˜ë©´ Ansible ì€ ìµœì‹  ë²„ì „ì˜ í”Œë ˆì´ë¶ì— ë”°ë¼ êµ¬ì„± ë³€ê²½ ì‚¬í•­ì„ ì¼ê´€ë˜ê²Œ ìœ ì§€í•˜ë ¤ê³  ê´€ë¦¬í•œë‹¤.
- Ansible ì€ ì•ˆì „í•œ ë³´ì•ˆê³¼ ACL ê¸°ëŠ¥ì´ í•¨ê»˜ ì œê³µë˜ëŠ” ë°˜ë©´ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì„œë¹„ìŠ¤ë‚˜ ìƒí˜¸ ì—°ê²°ëœ ì„œë¹„ìŠ¤ì—ëŠ” ì¢‹ì§€ ì•Šë‹¤.

## playbook
- í”Œë ˆì´ë¶(playbook) ì´ë€ í”Œë ˆì´(play) ë“¤ì˜ ëª¨ìŒì´ë‹¤
- ì¦‰, ëª¨ë“  í”Œë ˆì´ëŠ” í˜¸ìŠ¤íŠ¸(Host) + í…ŒìŠ¤í¬(Task) ì´ë©° ëˆ„êµ¬(Host)ì—ê²Œ ë¬´ìŠ¨ ì‘ì—…(Task)ì„ í• ê²ƒì¸ê°€ë¥¼ ì •ì˜í•œ ê²ƒì´ë‹¤
- í”Œë ˆì´ë¶ì€ í¬ê²Œ 3 ë¶€ë¶„ìœ¼ë¡œ ë‚˜ë‰œë‹¤.
1) íƒ€ê¹ƒ ë¶€ë¶„ : ì‹¤í–‰ ì¥ë¹„, ì–´ë–¤ì‚¬ìš©ì ë“±
2) ë³€ìˆ˜ ë¶€ë¶„ : ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜ ì •ì˜
3) íƒœìŠ¤í¬ ë¶€ë¶„ : ì‹¤í–‰í•˜ê³  ì‹¶ì€ ì•¡ì…˜

### íƒ€ê¹ƒ ë¶€ë¶„
- ì¤„ì˜ ì²˜ìŒì€ ëŒ€ì‹œ( - ) ë¡œ ì‹œì‘í•´ì•¼ í•œë‹¤. í”Œë ˆì´ê°€ ì‹¤í–‰ë  ì¥ë¹„ëŠ” hostsì˜ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ë©° ì•¤ì„œë¸” í”Œë ˆì´ë¶ì— ì¥ë¹„ì— ì—°ê²°í•  ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ ì•Œë¦°ë‹¤.

### ë³€ìˆ˜ ë¶€ë¶„
- ì „ì²´ í”Œë ˆì´ì— ì ìš©í•  ë³€ìˆ˜ë¥¼ ì •ì˜ í•˜ëŠ” ë¶€ë¶„ìœ¼ë¡œ ì´í›„ ìœ ì§€ë³´ìˆ˜ë¥¼ ì‰½ê²Œ í•  ìˆ˜ ìˆë„ë¡ ë³€ìˆ˜ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.
- ì¸ë²¤í† ë¦¬ì—ì„œ ì„¤ì •í•œ íŒ©íŠ¸ê°€ override ë  ìˆ˜ ìˆë‹¤.
- vars_files ì§€ì‹œìë¥¼ ì‚¬ìš©í•´ì„œ ì™¸ë¶€ YAML íŒŒì¼ì—ì„œë„ ì½ì–´ë“¤ì¼ ìˆ˜ ìˆë‹¤.
- ëŒ€í™”í˜•ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ë³€ìˆ˜ì˜ ê°’ì„ ì…ë ¥ë°›ì„ ìˆ˜ë„ ìˆë‹¤.
- ë‚´ì¥ë³€ìˆ˜ë„ ì¼ë¶€ ì¡´ì¬í•œë‹¤.

### íƒœìŠ¤í¬ ë¶€ë¶„
- ì›í•˜ëŠ” ìˆœì„œëŒ€ë¡œ ìˆ˜í–‰í•  ì•¡ì…˜ ëª©ë¡ì„ í¬í•¨í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.
- Name ì€ ì–´ë–¤ í”Œë ˆì´ ì¸ì§€ë¥¼ ì„¤ëª…í•œë‹¤.
- Become ì€ true ì¸ê²½ìš°, ë£¨íŠ¸(root) ì‚¬ìš©ìê°€ ë˜ì–´ ì‘ì—…ì„ ì‹¤í–‰í•œë‹¤.
- ì•¤ì„œë¸”ì— ì˜í•´ íŒ¨í‚¤ì§•ëœ ì•¡ì…˜ì„ ëª¨ë“ˆì´ë¼ê³  í•˜ë©° ì•¤ì„œë¸”ì—ëŠ” 2000ê°œ ì´ìƒì˜ ëª¨ë“ˆì´ í¬í•¨ë˜ì–´ ìˆë‹¤.

### [Ansible Example](https://github.com/ansible/ansible-examples)
- ansible-playbook -i hosts site.yml

1) site.yml
```yaml
---
- name: Install WordPress, MySQL, Nginx, and PHP-FPM
  hosts: all
  remote_user: root
  # remote_user: user
  # become: yes
  # become_method: sudo

  roles:
    - common
    - mysql
    - nginx
    - php-fpm
    - wordpress
```
2) group_vars/all
```yaml
---
# Which version of WordPress to deploy
wp_version: 4.2.4
wp_sha256sum: 42ca594afc709cbef8528a6096f5a1efe96dcf3164e7ce321e87d57ae015cc82

# These are the WordPress database settings
wp_db_name: wordpress 
wp_db_user: wordpress
wp_db_password: secret

# You shouldn't need to change this.
mysql_port: 3306

# This is used for the nginx server configuration, but access to the
# WordPress site is not restricted by a named host.
server_hostname: www.example.com

# Disable All Updates
# By default automatic updates are enabled, set this value to true to disable all automatic updates
auto_up_disable: false

#Define Core Update Level
#true  = Development, minor, and major updates are all enabled
#false = Development, minor, and major updates are all disabled
#minor = Minor updates are enabled, development, and major updates are disabled
core_update_level: true
```

3) wordpress-nginx/roles/wordpress/tasks/main.yml
```yaml
---
- name: Download WordPress
  get_url: url=http://wordpress.org/wordpress-{{ wp_version }}.tar.gz dest=/srv/wordpress-{{ wp_version }}.tar.gz
           sha256sum="{{ wp_sha256sum }}"

- name: Extract archive
  unarchive:
    creates: /srv/wordpress
    src: /srv/wordpress-{{ wp_version }}.tar.gz
    dest: /srv/wordpress

- name: Add group "wordpress"
  group: name=wordpress

- name: Add user "wordpress"
  user: name=wordpress group=wordpress home=/srv/wordpress/

- name: Fetch random salts for WordPress config
  get_url:
    url: https://api.wordpress.org/secret-key/1.1/salt/
  register: "wp_salt"
  become: no
  become_method: sudo
  changed_when: true
  delegate_to: localhost

- name: Create WordPress database
  mysql_db: name={{ wp_db_name }} state=present

- name: Create WordPress database user
  mysql_user: name={{ wp_db_user }} password={{ wp_db_password }} priv={{ wp_db_name }}.*:ALL host='localhost' state=present

- name: Copy WordPress config file
  template: src=wp-config.php dest=/srv/wordpress/

- name: Change ownership of WordPress installation
  file: path=/srv/wordpress/ owner=wordpress group=wordpress state=directory recurse=yes setype=httpd_sys_content_t

- name: Start php-fpm Service
  service: name=php-fpm state=started enabled=yes
```

4) wordpress-nginx/roles/wordpress/templates/wp-config.php
```yaml
<?php
/**
 * The base configurations of the WordPress.
 *
 * This file has the following configurations: MySQL settings, Table Prefix,
 * Secret Keys, WordPress Language, and ABSPATH. You can find more information
 * by visiting {@link http://codex.wordpress.org/Editing_wp-config.php Editing
 * wp-config.php} Codex page. You can get the MySQL settings from your web host.
 *
 * This file is used by the wp-config.php creation script during the
 * installation. You don't have to use the web site, you can just copy this file
 * to "wp-config.php" and fill in the values.
 *
 * @package WordPress
 */

// ** MySQL settings - You can get this info from your web host ** //
/** The name of the database for WordPress */
define('DB_NAME', '{{ wp_db_name }}');

/** MySQL database username */
define('DB_USER', '{{ wp_db_user }}');

/** MySQL database password */
define('DB_PASSWORD', '{{ wp_db_password }}');

/** MySQL hostname */
define('DB_HOST', 'localhost');

/** Database Charset to use in creating database tables. */
define('DB_CHARSET', 'utf8');

/** The Database Collate type. Don't change this if in doubt. */
define('DB_COLLATE', '');

/**#@+
 * Authentication Unique Keys and Salts.
 *
 * Change these to different unique phrases!
 * You can generate these using the {@link https://api.wordpress.org/secret-key/1.1/salt/ WordPress.org secret-key service}
 * You can change these at any point in time to invalidate all existing cookies. This will force all users to have to log in again.
 *
 * @since 2.6.0
 */

{{ wp_salt.stdout }}

/**#@-*/

/**
 * WordPress Database Table prefix.
 *
 * You can have multiple installations in one database if you give each a unique
 * prefix. Only numbers, letters, and underscores please!
 */
$table_prefix  = 'wp_';

/**
 * WordPress Localized Language, defaults to English.
 *
 * Change this to localize WordPress. A corresponding MO file for the chosen
 * language must be installed to wp-content/languages. For example, install
 * de_DE.mo to wp-content/languages and set WPLANG to 'de_DE' to enable German
 * language support.
 */
define('WPLANG', '');

/**
 * For developers: WordPress debugging mode.
 *
 * Change this to true to enable the display of notices during development.
 * It is strongly recommended that plugin and theme developers use WP_DEBUG
 * in their development environments.
 */
define('WP_DEBUG', false);

/** Disable Automatic Updates Completely */
define( 'AUTOMATIC_UPDATER_DISABLED', {{auto_up_disable}} );

/** Define AUTOMATIC Updates for Components. */
define( 'WP_AUTO_UPDATE_CORE', {{core_update_level}} );

/* That's all, stop editing! Happy blogging. */

/** Absolute path to the WordPress directory. */
if ( !defined('ABSPATH') )
	define('ABSPATH', dirname(__FILE__) . '/');

/** Sets up WordPress vars and included files. */
require_once(ABSPATH . 'wp-settings.php');
```